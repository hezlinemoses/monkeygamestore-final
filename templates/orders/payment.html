{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block dynamic_css %}<link rel="stylesheet" type="text/css" href="{% static "/styles/clientpanel/login.css" %}"> {% endblock dynamic_css %}
{% block content %}
<div class="container mt-5">
  

  <form action="" method="post" enctype="multipart/form-data">
    <div class="row">




      
      <div class="col-md-4 order-md-2 mb-4">
        <h4 class="d-flex justify-content-between align-items-center mb-3">
          <span class="fw-bold">Order summary</span>
          <span class="badge badge-secondary badge-pill"></span>
        </h4>
        <ul class="list-group mb-3">
          <li class="list-group-item d-flex justify-content-between lh-condensed dark-light ">
            <div class='col-4'>
              <small class="text-muted">Name</small>
            </div>
            <div class='col-4 text-center'>
              <small class="text-muted">Product Keys</small>
            </div>
            <div class='col-4 text-center'>
              <small class="text-muted">Price</small>
            </div>
          </li>
          {% for item in orderitems %}
          
          <li class="list-group-item d-flex justify-content-between lh-condensed dark-light ">
            <div class='col-4'>
              <h6 class="my-0 text-light capital">{{item.title}}</h6>
            </div>
            <div class='col-4 text-center'> 
              <span class='text-light ' >{{item.quantity}}</span>
            </div>

            <div class='col-4 text-center'> 
              <span class='text-light text-muted' ><del>₹{{item.item_total_before_discount}}</del></span>
              <span class='text-light' >₹{{item.item_total}}</span>
            </div>
          </li>
          {% endfor %}
          <li class="list-group-item d-flex justify-content-between">
            <span>Price</span>
            <strong>₹{{order.total_before_discount}}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Offer discount</span>
            <strong>₹{{order.total_discount_given}}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Coupon discount({{order.coupon_code}})</span>
            <strong>₹{{order.coupon_discount}}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Total (INR)</span>
            <strong>₹{{order.total}}</strong>
          </li>
        
          {% comment %} <li class="list-group-item d-flex justify-content-between bg-light">
            <div class="text-success">
              <h6 class="my-0">Promo code</h6>
              <small>EXAMPLECODE</small>
            </div>
            <span class="text-success">-$5</span>
          </li> {% endcomment %}
          
        </ul>
        
        <hr>
        
          {% csrf_token %}
    <h3 class='fw-bold'>Payment Method</h3>
        {% crispy paymentform %}
        <hr>     <!-- Set up a container element for the button -->
        <div id="paypal-button-container"></div>
        <button id="wallet-pay" type='button' onclick="check_wallet_pay();" class="btn btn-outline-success">Pay {{order.total}} from wallet</button>
    
        <!-- Include the PayPal JavaScript SDK -->
        <script src="https://www.paypal.com/sdk/js?client-id=ASzECi1kSx9P5g9hgGpIsMG6t_5lkMgcZWfdaQS3D1hl0a1uGfDj_5XtiV0mDwXLHjpXB9t6PJDpxnzu&currency=USD"></script>
    
        <script>
            // Render the PayPal button into #paypal-button-container
            var total = '{{order.total}}'
            
            paypal.Buttons({
                style: {
                  size:'responsive',
                  shape:'pill',
                },
                // Set up the transaction
                createOrder: function(data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: parseFloat(total).toFixed(2)
                            }
                        }]
                    });
                },
    
                // Finalize the transaction
                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(orderData) {
                        // Successful capture! For demo purposes:
                        console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
                        var transaction = orderData.purchase_units[0].payments.captures[0];
                       // alert('Transaction '+ transaction.status + ': ' + transaction.id + '\n\nSee console for all available details');
                        window.location.href="{% url 'paypalcomplete' %}";
    
                        // Replace the above to show a success message within this page, e.g.
                        // const element = document.getElementById('paypal-button-container');
                        // element.innerHTML = '';
                        // element.innerHTML = '<h3>Thank you for your payment!</h3>';
                        // Or go to another URL:  actions.redirect('thank_you.html');
                    });
                }
    
    
            }).render('#paypal-button-container');
            
        </script>
       
        {% comment %} .............................................................. {% endcomment %}
        <button class='btn col-12' style='background-color:#072654;color:white;' id="rzp-button1">Pay</button>
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
        <script>
        var options = {
            "key": "rzp_test_I9RCYsfQucqwM0", // Enter the Key ID generated from the Dashboard
            "amount": "{{payment.amount}}", // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            "currency": "INR",
            "name": "Monkey Game Store",
            "description": "Test Transaction",
            "image": "https://example.com/your_logo",
            "order_id": "{{payment.id}}", //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            "handler": function (response){
                window.location.href= "{% url 'razorpaycomplete' %}";
                //alert(response.razorpay_order_id);
                //alert(response.razorpay_signature)
            },
            
            "theme": {
                "color": "#3399cc"
            }
        };
        var rzp1 = new Razorpay(options);
        rzp1.on('payment.failed', function (response){
                alert(response.error.code);
                alert(response.error.description);
                alert(response.error.source);
                alert(response.error.step);
                alert(response.error.reason);
                alert(response.error.metadata.order_id);
                alert(response.error.metadata.payment_id);
        });
        document.getElementById('rzp-button1').onclick = function(e){
            rzp1.open();
            e.preventDefault();
        }
        </script>
        <hr>

      </div>


      <div class="col-md-8 order-md-1 ">
        <h4 class='fw-bold'>Billing Address</h4>
        <div class='col-6'>
          <ul class="list-group mb-3">
            
            <li class="list-group-item d-flex justify-content-between lh-condensed dark-light ">
              <div>
                <small class="text-light">Full Name:</small>
              </div>
              <div>
                <small class="text-light" style='text-transform:capitalize;'>{{order.billing_address.first_name}} {{order.billing_address.last_name}}</small>
              </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed dark-light ">
              <div>
                <small class="text-light">Line 1: </small>
              </div>
              <div>
                <small class="text-light" style='text-transform:capitalize;'>{{order.billing_address.line_1}}</small>
              </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed dark-light ">
              <div>
                <small class="text-light">Locality: </small>
              </div>
              <div>
                <small class="text-light" style='text-transform:capitalize;'>{{order.billing_address.locality}}</small>
              </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed dark-light ">
              <div>
                <small class="text-light">District: </small>
              </div>
              <div>
                <small class="text-light" style='text-transform:capitalize;'>{{order.billing_address.district}}</small>
              </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed dark-light ">
              <div>
                <small class="text-light">State: </small>
              </div>
              <div>
                <small class="text-light" style='text-transform:capitalize;'>{{order.billing_address.state}}</small>
              </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed dark-light ">
              <div>
                <small class="text-light">Pincode: </small>
              </div>
              <div>
                <small class="text-light" style='text-transform:capitalize;'>{{order.billing_address.pincode}}</small>
              </div>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed dark-light ">
              <div>
                <small class="text-light">Phone: </small>
              </div>
              <div>
                <small class="text-light" style='text-transform:capitalize;'>{{order.billing_address.phone}}</small>
              </div>
            </li>

          </ul>
        </div>
        
      </div>

      
    </div>
  </form>
  </div>
{% endblock content %}
{% block extrascript %}
<script>
  $('#wallet-pay').hide();
    var total = {{order.total}}
    var wallet = {{request.user.wallet}}
    if(total <= wallet){
      $('#id_payment_method_0').prop('disabled',false);
    }
    else{
      $('#id_payment_method_0').prop('disabled',true);
    }
    $("#paypal-button-container").hide();
    $("#rzp-button1").hide();
  $('input[name=payment_method]').click(function () {
    if (this.id == "id_payment_method_1") {
        $("#paypal-button-container").show('slow');
    } else {
        $("#paypal-button-container").hide('slow');
    }
    if (this.id=='id_payment_method_2'){
        $("#rzp-button1").show('slow');
    } else{
        $("#rzp-button1").hide('slow');
    }
    if (this.id=='id_payment_method_0') {
      $('#wallet-pay').show('slow');
    } else{
      $('#wallet-pay').hide('slow');
    }
  });

  function check_wallet_pay(){
    $.ajax({
      url:'/checkout/wallet/check',
      success: function(response){
        if(response.error_message){
          toastr.error(response.error_message);
        }
        if(response.success_message){
          toastr.success(response.error_message);
          window.location.href="{% url 'orderdetail' order.id %}";
        }
        
      },
      error: function(){
      },
    });
  }
</script>
{% endblock extrascript %}